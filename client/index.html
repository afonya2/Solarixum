<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Secure chats</title>
        <style>
            body {
                background-color: #0a1428;
                color: #ebf0fa;
            }
        </style>
    </head>
    <body>
        <input type="text" placeholder="Username" id="username">
        <input type="password" placeholder="Password" id="password">
        <button onclick="register()">Register</button>
        <script>
            function generateRandomString(length) {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            }
            async function register() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const recoveryWord = generateRandomString(256);
                console.log("Recovery word:", recoveryWord);
                
                let key = await crypto.subtle.generateKey({
                    name: "RSA-OAEP",
                    modulusLength: 4096,
                    publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
                    hash: "SHA-256"
                }, true, ["encrypt", "decrypt"]);
                let exportedKey = await crypto.subtle.exportKey("pkcs8", key.privateKey);
                let iv = crypto.getRandomValues(new Uint8Array(16));
                console.log("IV:", iv);
                //We need to hash the recovery word to use it as a key for AES encryption
                let hash = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(recoveryWord));
                let keyBuffer = await crypto.subtle.importKey("raw", hash, { name: "AES-CBC" }, false, ["encrypt"]);
                let encryptedKey = await crypto.subtle.encrypt({
                    name: "AES-CBC",
                    iv: iv
                }, keyBuffer, exportedKey);
                let encryptedKeyHex = Array.from(new Uint8Array(encryptedKey)).map(b => b.toString(16).padStart(2, '0')).join('');

                let req = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, privateKey: encryptedKeyHex })
                });
                let res = await req.json();
                console.log(res);
            }
        </script>
    </body>
</html>