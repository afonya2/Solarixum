<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Secure chats</title>
        <style>
            body {
                background-color: #0a1428;
                color: #ebf0fa;
            }
        </style>
    </head>
    <body>
        <input type="text" placeholder="Username" id="username">
        <input type="password" placeholder="Password" id="password">
        <button onclick="register()">Register</button>
        <script>
            function generateRandomString(length) {
                const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                let result = '';
                for (let i = 0; i < length; i++) {
                    result += characters.charAt(Math.floor(Math.random() * characters.length));
                }
                return result;
            }
            function keyToHex(key) {
                return Array.from(new Uint8Array(key)).map(b => b.toString(16).padStart(2, '0')).join('')
            }
            async function register() {
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const recoveryWord = generateRandomString(32);
                console.log("Recovery word:", recoveryWord);
                
                let key = await crypto.subtle.generateKey({
                    name: "RSA-OAEP",
                    modulusLength: 4096,
                    publicExponent: new Uint8Array([0x01, 0x00, 0x01]),
                    hash: "SHA-256"
                }, true, ["encrypt", "decrypt"]);
                let exportedPrivKey = await crypto.subtle.exportKey("pkcs8", key.privateKey);
                let iv = crypto.getRandomValues(new Uint8Array(16));
                console.log("IV:", keyToHex(iv));
                let keyBuffer = await crypto.subtle.importKey("raw", new TextEncoder().encode(recoveryWord), { name: "AES-CBC" }, false, ["encrypt"]);
                let encryptedPrivKey = await crypto.subtle.encrypt({
                    name: "AES-CBC",
                    iv: iv
                }, keyBuffer, exportedPrivKey);
                let privateKeyHex = keyToHex(encryptedPrivKey);
                let exportedPubKey = await crypto.subtle.exportKey("spki", key.publicKey);
                let publicKeyHex = keyToHex(exportedPubKey);

                let req = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, privateKey: privateKeyHex, publicKey: publicKeyHex })
                });
                let res = await req.json();
                console.log(res);
            }
        </script>
    </body>
</html>